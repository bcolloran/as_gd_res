
**Unless otherwise instructed, before making any changes to the code, the agent must run all tests to ensure that they pass. If any tests fail, the agent must immediately halt all work and inform the user. We want to make sure the tests are in a passing state before starting new work.**

# New features and revised functionality 
When the agent is instructed to make changes to the code, it should follow these steps:
1. **Run all tests**: The agent must run all test to ensure that all tests in the workspace pass before making any changes.
2. **Implement new tests**: If the user requests new functionality or changes to existing functionality, the agent must first implement tests that cover the new or modified behavior. The agent should not modify any code until the tests are in place.
3. **Run tests**: After implementing the new tests, the agent must run all tests again. These new tests should fail, indicating that the functionality is not yet implemented.
4. **Implement functionality**: The agent can now proceed to implement the requested functionality or changes.
5. **Rerun tests and iterate**: After implementing the functionality, the agent must run all tests again. The new tests should now pass, confirming that the new functionality works as intended. If any tests fail, the agent must address the issues before proceeding.

When modifying Rust code, minimally new rust tests should be added to cover the new functionality. If the new functionality is complex, the agent should also consider adding integration tests in the Godot project to ensure that the Rust code interacts correctly with Godot.



# Testing

## Running Rust tests

The agent should always run `cargo test` in the workspace root to run all tests in the workspace, not just the tests in the current crate. Do not pass additional flags to `cargo test` unless specifically requested by the user.

## Running Godot integration tests



## Verifying resource extraction output (end to end test)
The repository includes a helper script `codex_scripts/test_resource_extract.sh`
which runs `test_scene.tscn` headlessly and compares the printed output with
`expected_rust_print_output.txt`. The script automatically preloads the
extension's script classes by running the editor once in headless mode.
Run it after building the extension and setting `GODOT_BIN` to verify the
scene output:

1. Download Godot and set the `GODOT_BIN` environment variable. __TO GET THE CURRENT DOWNLOAD LINK, THE LINK IN THE FILE `.github/workflows/resource_output_test.yml`__. That is the source of truth for the download link. With that in mind, the commands will look something like this (**but be sure to get the correct link from the file mentioned above, and ups the correct corresponding file name!**):
   ```bash
   curl -L https://github.com/godotengine/godot-builds/releases/download/4.x.x-stable/Godot_v4.x.x-stable_linux.x86_64.zip -o godot.zip
   unzip godot.zip -d /usr/local/bin
   export GODOT_BIN=/usr/local/bin/Godot_v4.x.x-stable_linux.x86_64
   chmod +x "$GODOT_BIN"
   ```
- Ensure `xvfb-run` is available (install `xvfb` if necessary).

- Build the Rust extension so the `.gdextension` file can locate the library:
   ```bash
   cargo build
   ```

- run the test script:
```bash
./codex_scripts/test_resource_extract.sh
```

### Updating end to end test
The output printed to the console by the Rust code in `test_scene.tscn` is generated by the `godot_print!` statements in `resource_test_rust/src/lib.rs`. Generally, the agent should not need to modify this code. However, for example, something like a new type is added to the types that can be extracted, the agent may need to modify `resource_test_rust/src/lib.rs` with additional `godot_print!` statements to ensure that the new type is extracted correctly.

### Updating expected output
If the output changes the agent may need to update the expected output file `expected_rust_print_output.txt`. In this case, the agent MUST review the output VERY CAREFULLY to ensure that the changes are intentional and correct. After updating the expected output, the agent should run the test script again to ensure that it passes with the new expected output.


